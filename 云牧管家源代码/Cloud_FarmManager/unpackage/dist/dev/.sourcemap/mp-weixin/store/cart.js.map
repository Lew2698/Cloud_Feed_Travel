{"version":3,"file":"cart.js","sources":["store/cart.js"],"sourcesContent":["// 购物车状态管理\nclass CartStore {\n\tconstructor() {\n\t\tthis.cartItems = [];\n\t\tthis.currentUserId = null;\n\t\tthis.loadCartFromStorage();\n\t}\n\n\t// 获取当前用户ID\n\tgetCurrentUserId() {\n\t\ttry {\n\t\t\tconst userInfo = uni.getStorageSync('userInfo');\n\t\t\treturn userInfo && userInfo.userId ? userInfo.userId : 'guest';\n\t\t} catch (error) {\n\t\t\tconsole.error('获取用户ID失败:', error);\n\t\t\treturn 'guest';\n\t\t}\n\t}\n\n\t// 获取用户专属的存储key\n\tgetUserCartKey(userId = null) {\n\t\tconst uid = userId || this.getCurrentUserId();\n\t\treturn `cart_items_${uid}`;\n\t}\n\n\t// 从本地存储加载购物车数据\n\tloadCartFromStorage() {\n\t\ttry {\n\t\t\tconst currentUserId = this.getCurrentUserId();\n\t\t\t\n\t\t\t// 如果用户发生变化，清空当前购物车数据\n\t\t\tif (this.currentUserId && this.currentUserId !== currentUserId) {\n\t\t\t\tthis.cartItems = [];\n\t\t\t}\n\t\t\t\n\t\t\tthis.currentUserId = currentUserId;\n\t\t\tconst cartKey = this.getUserCartKey(currentUserId);\n\t\t\tconst cartData = uni.getStorageSync(cartKey);\n\t\t\t\n\t\t\tif (cartData) {\n\t\t\t\tthis.cartItems = JSON.parse(cartData);\n\t\t\t} else {\n\t\t\t\tthis.cartItems = [];\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('加载购物车数据失败:', error);\n\t\t\tthis.cartItems = [];\n\t\t}\n\t}\n\n\t// 保存购物车数据到本地存储\n\tsaveCartToStorage() {\n\t\ttry {\n\t\t\tconst currentUserId = this.getCurrentUserId();\n\t\t\tconst cartKey = this.getUserCartKey(currentUserId);\n\t\t\tuni.setStorageSync(cartKey, JSON.stringify(this.cartItems));\n\t\t} catch (error) {\n\t\t\tconsole.error('保存购物车数据失败:', error);\n\t\t}\n\t}\n\n\t// 切换用户时调用此方法\n\tswitchUser() {\n\t\tconst newUserId = this.getCurrentUserId();\n\t\tif (this.currentUserId !== newUserId) {\n\t\t\tthis.currentUserId = newUserId;\n\t\t\tthis.loadCartFromStorage();\n\t\t\tthis.notifyCartUpdate();\n\t\t}\n\t}\n\n\t// 清除指定用户的购物车数据\n\tclearUserCart(userId = null) {\n\t\ttry {\n\t\t\tconst uid = userId || this.getCurrentUserId();\n\t\t\tconst cartKey = this.getUserCartKey(uid);\n\t\t\tuni.removeStorageSync(cartKey);\n\t\t\t\n\t\t\t// 如果清除的是当前用户的数据，也清空内存中的数据\n\t\t\tif (uid === this.currentUserId) {\n\t\t\t\tthis.cartItems = [];\n\t\t\t\tthis.notifyCartUpdate();\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('清除用户购物车数据失败:', error);\n\t\t}\n\t}\n\n\t// 添加商品到购物车\n\taddToCart(product, quantity = 1, specs = '默认规格') {\n\t\t// 确保使用当前用户的数据\n\t\tthis.switchUser();\n\t\t\n\t\tconst existingItemIndex = this.cartItems.findIndex(item => \n\t\t\titem.id === product.id && item.specs === specs\n\t\t);\n\n\t\tif (existingItemIndex !== -1) {\n\t\t\t// 如果商品已存在，增加数量\n\t\t\tthis.cartItems[existingItemIndex].quantity += quantity;\n\t\t} else {\n\t\t\t// 如果商品不存在，添加新商品\n\t\t\tconst cartItem = {\n\t\t\t\tid: product.id,\n\t\t\t\tname: product.name,\n\t\t\t\tprice: product.price,\n\t\t\t\timage: product.image,\n\t\t\t\tspecs: specs,\n\t\t\t\tquantity: quantity,\n\t\t\t\tselected: true\n\t\t\t};\n\t\t\tthis.cartItems.push(cartItem);\n\t\t}\n\n\t\tthis.saveCartToStorage();\n\t\tthis.notifyCartUpdate();\n\t\t\n\t\treturn true;\n\t}\n\n\t// 更新商品数量\n\tupdateQuantity(index, quantity) {\n\t\tthis.switchUser();\n\t\t\n\t\tif (index >= 0 && index < this.cartItems.length) {\n\t\t\tif (quantity <= 0) {\n\t\t\t\tthis.removeItem(index);\n\t\t\t} else {\n\t\t\t\tthis.cartItems[index].quantity = quantity;\n\t\t\t\tthis.saveCartToStorage();\n\t\t\t\tthis.notifyCartUpdate();\n\t\t\t}\n\t\t}\n\t}\n\n\t// 切换商品选中状态\n\ttoggleItemSelect(index) {\n\t\tthis.switchUser();\n\t\t\n\t\tif (index >= 0 && index < this.cartItems.length) {\n\t\t\tthis.cartItems[index].selected = !this.cartItems[index].selected;\n\t\t\tthis.saveCartToStorage();\n\t\t\tthis.notifyCartUpdate();\n\t\t}\n\t}\n\n\t// 移除商品\n\tremoveItem(index) {\n\t\tthis.switchUser();\n\t\t\n\t\tif (index >= 0 && index < this.cartItems.length) {\n\t\t\tthis.cartItems.splice(index, 1);\n\t\t\tthis.saveCartToStorage();\n\t\t\tthis.notifyCartUpdate();\n\t\t}\n\t}\n\n\t// 清空购物车\n\tclearCart() {\n\t\tthis.switchUser();\n\t\t\n\t\tthis.cartItems = [];\n\t\tthis.saveCartToStorage();\n\t\tthis.notifyCartUpdate();\n\t}\n\n\t// 全选/取消全选\n\ttoggleSelectAll() {\n\t\tthis.switchUser();\n\t\t\n\t\tconst allSelected = this.cartItems.every(item => item.selected);\n\t\tthis.cartItems.forEach(item => {\n\t\t\titem.selected = !allSelected;\n\t\t});\n\t\tthis.saveCartToStorage();\n\t\tthis.notifyCartUpdate();\n\t}\n\n\t// 获取购物车商品总数\n\tgetTotalCount() {\n\t\tthis.switchUser();\n\t\treturn this.cartItems.reduce((total, item) => total + item.quantity, 0);\n\t}\n\n\t// 获取选中商品总数\n\tgetSelectedCount() {\n\t\tthis.switchUser();\n\t\treturn this.cartItems\n\t\t\t.filter(item => item.selected)\n\t\t\t.reduce((total, item) => total + item.quantity, 0);\n\t}\n\n\t// 获取选中商品总价\n\tgetSelectedTotalPrice() {\n\t\tthis.switchUser();\n\t\treturn this.cartItems\n\t\t\t.filter(item => item.selected)\n\t\t\t.reduce((total, item) => total + item.price * item.quantity, 0);\n\t}\n\n\t// 获取选中的商品列表\n\tgetSelectedItems() {\n\t\tthis.switchUser();\n\t\treturn this.cartItems.filter(item => item.selected);\n\t}\n\n\t// 获取所有购物车商品\n\tgetCartItems() {\n\t\tthis.switchUser();\n\t\treturn this.cartItems;\n\t}\n\n\t// 检查是否全选\n\tisAllSelected() {\n\t\tthis.switchUser();\n\t\treturn this.cartItems.length > 0 && this.cartItems.every(item => item.selected);\n\t}\n\n\t// 通知购物车更新（用于页面间通信）\n\tnotifyCartUpdate() {\n\t\t// 发送自定义事件通知购物车更新\n\t\tuni.$emit('cartUpdated', {\n\t\t\ttotalCount: this.getTotalCount(),\n\t\t\tselectedCount: this.getSelectedCount(),\n\t\t\ttotalPrice: this.getSelectedTotalPrice(),\n\t\t\titems: this.cartItems,\n\t\t\tuserId: this.currentUserId\n\t\t});\n\t}\n\n\t// 根据商品ID查找商品\n\tfindItemById(productId) {\n\t\tthis.switchUser();\n\t\treturn this.cartItems.find(item => item.id === productId);\n\t}\n\n\t// 获取商品在购物车中的数量\n\tgetItemQuantity(productId) {\n\t\tthis.switchUser();\n\t\tconst item = this.findItemById(productId);\n\t\treturn item ? item.quantity : 0;\n\t}\n\n\t// 获取当前用户信息（用于调试）\n\tgetCurrentUserInfo() {\n\t\treturn {\n\t\t\tuserId: this.currentUserId,\n\t\t\tcartKey: this.getUserCartKey(),\n\t\t\titemCount: this.cartItems.length\n\t\t};\n\t}\n}\n\n// 创建全局购物车实例\nconst cartStore = new CartStore();\n\nexport default cartStore; "],"names":["uni"],"mappings":"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"}